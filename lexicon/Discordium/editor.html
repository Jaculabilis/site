<html>
<head>
<title>Lexicon Editor</title>
<style>
	html, body { height:100%; margin:0px; }
	div.outer { overflow:overlay; }
	span.signature { text-align: right; }
	a.phantom { color: #ff0000; }
	a.denovo { color: #008800; }
	@media only screen and (min-width: 768px) {
		div.column { float:left; width:50%; }
	}
</style>
<script>
	writtenArticles = [
		{title: "~Cincinatta Rubric, MsD", author: "TVB-CR"},{title: "~Dr. Herbert Jones", author: "NVB-HJ"},{title: "~Gwen Hanson, PhD", author: "NVB-GH"},{title: "~Pierce Milton, MHO", author: "NVB-PM"},{title: "~Remilion Christophy, PhD", author: "TVB-RC"},{title: "~Spheven Kain", author: "TVB-SK"},{title: "â‡’ Forward", author: "NVB-HJ"},{title: "The Contagious Republic of Paul Vigotski", author: "NVB-PM"},{title: "Flandrean National Response Protocol BX-392a", author: "TVB-CR"},{title: "Lepazzia", author: "NVB-HJ"},{title: "Taurus Research Station", author: "NVB-GH"},{title: "X-treme lecturing", author: "TVB-SK"},{title: "ðŸ”‡", author: "TVB-RC"},{title: "Barcuvian antiweather", author: "TVB-CR"},{title: "The Hegemony of Whales", author: "TVB-RC"},{title: "The I'll Legislate It, I Swear, Don't Think I Won't Act", author: "NVB-GH"},{title: "Incendia", author: "TVB-SK"},{title: "Pantheons of Kingsland", author: "NVB-PM"},{title: "Symphonic warp traversal", author: "NVB-HJ"},{title: "Electric undead", author: "NVB-GH"},{title: "Flandre", author: "NVB-HJ"},{title: "High Exarch Minor Seraphi Ironheart", author: "NVB-PM"},{title: "The Killer Bus of Kingsland North", author: "TVB-SK"},{title: "The Panark Fleet", author: "TVB-RC"},{title: "Professor (allegedly) Marvin Fitch", author: "TVB-CR"},{title: "The Double-North Pole", author: "NVB-HJ"},{title: "The Lunchtime Fallacy", author: "TVB-RC"},{title: "Massively Parallel Peace Conference", author: "NVB-GH"},{title: "Omega Point Coffee Secretor", author: "TVB-SK"},{title: "Selestei", author: "TVB-CR"},{title: "The Ulgravian Diaspora", author: "NVB-PM"},{title: "Assemblies of Gods", author: "TVB-CR"},{title: "Buddy \"Literally Made of Snakes\" Johnson", author: "TVB-SK"},{title: "The Fractured Cities", author: "NVB-GH"},{title: "Marionette children", author: "TVB-RC"},{title: "National Academy of Velskyavo", author: "NVB-HJ"},{title: "The Venerable Society of Cartographers", author: "NVB-PM"},{title: "The Dark Pentad", author: "NVB-PM"},{title: "General Kade \"Ripper\" Gorson", author: "TVB-SK"},{title: "Tesseraction Eve", author: "NVB-HJ"},{title: "The Very Definitely Independent States", author: "TVB-CR"},{title: "The War of Durun's Ass", author: "TVB-RC"},{title: "Windstriding", author: "NVB-GH"},{title: "The Careless Continent", author: "TVB-SK"},{title: "Horseball", author: "TVB-RC"},{title: "Placeholden", author: "TVB-CR"},{title: "Shaster", author: "NVB-HJ"},{title: "Yasser's Yells", author: "NVB-HJ"},{title: "Zor Olo", author: "NVB-GH"},{title: "The Book of Schemes", author: "TVB-CR"},{title: "The Esoteric Order of Florists", author: "TVB-SK"},{title: "Mad legal practice", author: "NVB-PM"},{title: "Missing Sea", author: "TVB-RC"},{title: "The Partitioning", author: "NVB-GH"},{title: "The Yggdrasil Project", author: "NVB-PM"},{title: "986 Bring Your Daughter to Work Day incident", author: "NVB-HJ"},{title: "Bloodmoot", author: "TVB-CR"},{title: "Joran Lake", author: "TVB-RC"},{title: "Professor Hazard McKinley", author: "NVB-PM"},{title: "Space persuasion", author: "TVB-SK"},{title: "Stratsky Foundation for Economics and Insurrection", author: "NVB-GH"},{title: "The Botherhood", author: "NVB-PM"},{title: "Chromatic aberration", author: "TVB-RC"},{title: "Grim Weepers", author: "NVB-HJ"},{title: "Klaus Santanna", author: "TVB-CR"},{title: "Xenoarcheological ruins", author: "TVB-SK"},{title: "Zeitgeist Manipulator", author: "NVB-GH"},{title: "Asynchronous energy", author: "TVB-RC"},{title: "Captain Jango \"Space\" Gunnerson", author: "NVB-PM"},{title: "Metafishics", author: "NVB-HJ"},{title: "The Night of Storms", author: "NVB-GH"},{title: "Ominous fixed-point cubes", author: "TVB-SK"},{title: "Qualified spontaneous evaporation", author: "TVB-CR"},{title: "Biosphere fascism", author: "NVB-GH"},{title: "Chorus Perpetual", author: "TVB-CR"},{title: "Hard light projection", author: "TVB-RC"},{title: "Iurezza (Sneezing on the King Eternal album)", author: "NVB-HJ"},{title: "JalapeÃ±osis", author: "TVB-SK"},{title: "The Roerbach Incident", author: "NVB-PM"},{title: "Goats on Boats Affair", author: "NVB-PM"},{title: "Iurezza (continent)", author: "NVB-HJ"},{title: "Legend of the Three Trees", author: "TVB-SK"},{title: "Mad King Westler", author: "TVB-RC"},{title: "Queen Beneficent the Plenitudinous", author: "TVB-CR"},{title: "Ravenous Squid-Trees", author: "NVB-GH"},{title: "DAS Secretary Ruby Tomas", author: "TVB-RC"},{title: "High Illuminator Saint Doctor Heinrich Stafford", author: "NVB-HJ"},{title: "Joint University Strike Team for Interdisciplinary Collaboration Enforcement", author: "TVB-CR"},{title: "Pentex Lannogaster", author: "NVB-PM"},{title: "Razor Valley", author: "TVB-SK"},{title: "Ultimate Dragonopolis", author: "NVB-GH"},{title: "Concluding Recommendations: Spheven Kain", author: "NVB-HJ"},
	]
	phantomArticles = [
		
	]

	function updatePreview() {
		var articlePlayer = document.getElementById("article-player").value;
		var articleTitle = document.getElementById("article-title").value;
		var articleBody = document.getElementById("article-body").value;
		var previewHtml = "<h1>" + articleTitle + "</h1>\n";
		if (phantomArticles.some(e => (e.title === articleTitle && e.citedby.some(p => (p === articlePlayer))))) {
			previewHtml += "<p><span style=\"color:#dd0000\">You've cited this article!</span></p>"
		}
		previewHtml += parseLexipythonMarkdown(articleBody);
		document.getElementById("preview").innerHTML = previewHtml;
	}

	function parseLexipythonMarkdown(text) {
		// Parse the content and extract citations
		var paras = text.trim().split(/\n\n+/);
		content = "";
		citationList = [];
		formatId = 1;
		hasSignature = false;
		for (var i = 0; i < paras.length; i++) {
			var para = paras[i];
			// Escape angle brackets
			para = para.replace(/</g, "&lt;");
			para = para.replace(/>/g, "&gt;");
			// Replace bold and italic marks with tags
			para = para.replace(/\/\/([^\/]+)\/\//g, "<i>$1</i>");
			para = para.replace(/\*\*([^*]+)\*\*/g, "<b>$1</b>");
			// Replace \\LF with <br>LF
			para = para.replace(/\\\\\n/g, "<br>\n");
			// Abstract citations into the citation record
			linkMatch = para.match(/\[\[(([^|\[\]]+)\|)?([^|\[\]]+)\]\]/);
			while (linkMatch != null) {
				// Identify the citation text and cited article
				citeText = linkMatch[2] != null ? linkMatch[2] : linkMatch[3];
				citeTitle = linkMatch[3].charAt(0).toUpperCase() + linkMatch[3].slice(1);
				citeClass = "class=\"denovo\"";
				if (writtenArticles.some(function(e) { return e.title === citeTitle; })) {
					citeClass = ""
				} else if (phantomArticles.some(function(e) { return e.title === citeTitle; })) {
					citeClass = "class=\"phantom\"";
				}
				// Record the citation
				citationList.push([formatId, citeTitle]);
				// Stitch the cite text in place of the citation, plus a cite number
				para =
					para.slice(0, linkMatch.index) +
					"<a " +
					citeClass +
					" href=\"#\">" +
					citeText +
					"</a>" +
					"<sup>" +
					formatId.toString() +
					"</sup>" +
					para.slice(linkMatch.index + linkMatch[0].length);
				formatId += 1; // Increment to the next format id
				linkMatch = para.match(/\[\[(([^|\[\]]+)\|)?([^|\[\]]+)\]\]/);
			}
			// Convert signature to right-aligned
			if (para.length > 0 && para[0] == "~") {
				para = "<hr><span class=\"signature\"><p>" + para.slice(1) + "</p></span>";
				hasSignature = true;
			} else {
				para = "<p>" + para + "</p>\n";
			}
			content += para;
		}
		if (!hasSignature) {
			content += "<p><span style=\"color:#dd0000\">Article has no signature</span></p>";
		}
		if (citationList.length > 0) {
			var player = document.getElementById("article-player").value;
			content += "<p><i>The following articles will be cited:</i></p>\n";
			for (var i = 0; i < citationList.length; i++) {
				citation = citationList[i][0].toString() + ". " + citationList[i][1];
				if (writtenArticles.some(e => (e.title === citationList[i][1]) && (e.author === player))) {
					content += "<p><span style=\"color:#ff0000\">" + citation + " [Written by you!]</span></p>";
				} else if (writtenArticles.some(e => (e.title === citationList[i][1]))) {
					content += "<p>" + citation + " [Written]";
				} else if (phantomArticles.some(e => (e.title === citationList[i][1]))) {
					content += "<p>" + citation + " [Phantom]";
				} else {
					content += "<p>" + citation + " [New]";
				}
				content += "</p>\n";
			}
		}
		// Calculate approximate word count
		var wordCount = text.trim().split(/\s+/).length;
		if (text.trim().length < 1)
			wordCount = 0;
		content += "<p><i>Article length: approx. " + wordCount + " words</p>";

		return content;
	}

	function download() {
		var articlePlayer = document.getElementById("article-player").value;
		var articleTurn = document.getElementById("article-turn").value;
		var articleTitle = document.getElementById("article-title").value;
		var articleBody = document.getElementById("article-body").value;
		var articleText =
			"# Player: " + articlePlayer + "\n" +
			"# Turn: " + articleTurn + "\n" +
			"# Title: " + articleTitle + "\n" +
			"\n" +
			articleBody;
		var articleFilename = articleTitle.toLowerCase().replace(/[^a-z0-9- ]/g, "").replace(/ +/g, "-");
		articleFilename += "-" + articleTurn.toString();
		var downloader = document.createElement("a");
		downloader.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(articleText));
		downloader.setAttribute("download", articleFilename);
		if (document.createEvent) {
			var event = document.createEvent("MouseEvents");
			event.initEvent("click", true, true);
			downloader.dispatchEvent(event);
		} else {
			downloader.click();
		}
	}

	window.onload = updatePreview;

	window.addEventListener("beforeunload", function(e) {
		var hasText = document.getElementById("article-body").value.length > 0;
		if (hasText) {
			e.returnValue = "Are you sure?";
		}
	});
</script>
</head>
<body>
<center>
<h1>Lexicon Editor</h1>
</center>
<button onclick="download()">Download as .txt</button>
<div class="outer">
	<div class="column">
		<table style="width:100%">
		<tr><td># Player:</td>
		<td><input id="article-player" style="width:100%;" value="PN" oninput="updatePreview()"/></td>
		</tr>
		<tr><td># Turn:</td>
		<td><input id="article-turn" style="width:100%" value="17"/></td>
		</tr>
		<tr><td># Title:</td>
		<td><input id="article-title" style="width:100%" value="Example Page" oninput="updatePreview()" /></td>
		</tr>
		<tr><td colspan="2">
		<textarea id="article-body" style="width:100%; resize:vertical" rows=8 oninput="updatePreview()"></textarea>
		</td></tr></table>
	</div>
	<div class="column">
		<div id="preview" style="padding: 0 10px"></div>
	</div>
</div>
</body>
</html>
